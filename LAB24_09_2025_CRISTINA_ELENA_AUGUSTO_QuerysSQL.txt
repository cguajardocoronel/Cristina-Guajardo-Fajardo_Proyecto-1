use customers;

/************************************
EJERCICIO 1
************************************/

-- Contactos de oficina: Tiene una tabla que contiene los códigos de oficina y sus números de teléfono asociados.
SELECT officeCode, phone
FROM offices;

-- Detectives de correo electrónico: ¿Puede identificar a los empleados cuyas direcciones de correo electrónico terminan en “.es”?
SELECT employeeNumber, lastName, firstName, email
FROM employees
WHERE email LIKE '%.es';

-- Estado de confusión: descubra qué clientes carecen de información estatal en sus registros.
SELECT customerNumber, customerName, city, state
FROM customers
WHERE state IS NULL;

-- Grandes gastadores: busquemos pagos que superen los $20.000.
SELECT customerNumber, checkNumber, paymentDate, amount
FROM payments
WHERE amount > 20000;

-- Grandes gastadores de 2005: pagos mayores a $20,000 realizados en 2005.
SELECT customerNumber, checkNumber, paymentDate, amount
FROM payments
WHERE amount > 20000
  AND YEAR(paymentDate) = 2005;

-- Detalles distintos: filas únicas de orderdetails en función de productCode.
SELECT DISTINCT productCode
FROM orderdetails;

-- Estadísticas globales de compradores: recuento de compras realizadas por país.
SELECT country, COUNT(o.orderNumber) AS total_pedidos
FROM customers c
JOIN orders o ON c.customerNumber = o.customerNumber
GROUP BY country;


/************************************
EJERCICIO 2
************************************/

-- Descripción de línea de producto más larga.
SELECT productLine, LENGTH(textDescription) AS longitud
FROM productlines
ORDER BY longitud DESC
LIMIT 1;

-- Recuento de clientes de oficina: número de clientes asociados a cada oficina.
SELECT e.officeCode, COUNT(DISTINCT c.customerNumber) AS total_clientes
FROM employees e
JOIN customers c ON e.employeeNumber = c.salesRepEmployeeNumber
GROUP BY e.officeCode;

-- Día de mayores ventas de automóviles: día de la semana con mayor número de pedidos de productos de línea 'Classic Cars'.
SELECT DAYNAME(o.orderDate) AS dia_semana, COUNT(*) AS total_ventas
FROM orders o
JOIN orderdetails od ON o.orderNumber = od.orderNumber
JOIN products p ON od.productCode = p.productCode
WHERE p.productLine = 'Classic Cars'
GROUP BY dia_semana
ORDER BY total_ventas DESC
LIMIT 1;

-- Corrección de datos territoriales faltantes: valores NA de territory pasan a 'USA'.
SELECT officeCode,
       city,
       CASE 
            WHEN territory IS NULL OR territory = 'NA' THEN 'USA'
            ELSE territory
       END AS territory_corrected
FROM offices;

-- Estadísticas de empleados de la familia Patterson (2004-2005).
SELECT YEAR(o.orderDate) AS anio,
       MONTH(o.orderDate) AS mes,
       AVG(od.quantityOrdered * od.priceEach) AS promedio_carrito,
       SUM(od.quantityOrdered) AS total_articulos
FROM customers c
JOIN employees e ON c.salesRepEmployeeNumber = e.employeeNumber
JOIN orders o ON c.customerNumber = o.customerNumber
JOIN orderdetails od ON o.orderNumber = od.orderNumber
WHERE (e.lastName = 'Patterson')
  AND YEAR(o.orderDate) IN (2004, 2005)
GROUP BY anio, mes;


/************************************
EJERCICIO 3 (Subconsultas)
************************************/

-- Análisis de compras anuales con subconsultas (2004 y 2005, clientes de empleados Patterson).
SELECT anio, mes,
       AVG(total_carrito) AS promedio_carrito,
       SUM(total_items) AS total_articulos
FROM (
    SELECT YEAR(o.orderDate) AS anio,
           MONTH(o.orderDate) AS mes,
           o.orderNumber,
           SUM(od.quantityOrdered * od.priceEach) AS total_carrito,
           SUM(od.quantityOrdered) AS total_items
    FROM customers c
    JOIN employees e ON c.salesRepEmployeeNumber = e.employeeNumber
    JOIN orders o ON c.customerNumber = o.customerNumber
    JOIN orderdetails od ON o.orderNumber = od.orderNumber
    WHERE e.lastName = 'Patterson'
      AND YEAR(o.orderDate) IN (2004, 2005)
    GROUP BY anio, mes, o.orderNumber
) AS sub
GROUP BY anio, mes;

-- Viaje a la oficina: oficinas con empleados que atienden a clientes sin información estatal.
SELECT DISTINCT e.officeCode
FROM employees e
JOIN customers c ON e.employeeNumber = c.salesRepEmployeeNumber
WHERE c.state IS NULL;
